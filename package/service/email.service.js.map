{"version":3,"sources":["../src/service/email.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA,2CAA2D;AAC3D,qEAAiE;AACjE,6BAA6B;AAC7B,2CAA6C;AAC7C,6CAAmD;AACnD,qCAAqC;AAIrC,IAAa,YAAY,GAAzB;IACC,YAEmB,cAA6C;QAA7C,mBAAc,GAAd,cAAc,CAA+B;IAC7D,CAAC;IAUG,SAAS,CAAC,QAAa,EAAE,GAAW,EAAE,KAAe,EAAE,MAAc;;YACzE,MAAM,WAAW,GAAkC,MAAM,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YAC1F,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC;gBACjB,MAAM,IAAI,sBAAa,CAAC,WAAW,EAAE,GAAG,CAAC,CAAC;YAC5C,CAAC;YACD,EAAE,CAAC,CAAC,KAAK,CAAC,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC;gBACtB,MAAM,IAAI,sBAAa,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC;YACzC,CAAC;YACD,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;gBACtC,MAAM,GAAG,GAAG,GAAG,WAAW,CAAC,MAAM,EAAE,CAAC;gBAEpC,MAAM,QAAQ,GAAG,YAAM,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC;gBACvC,MAAM,WAAW,GAAG;oBAElB,IAAI,EAAE,GAAG,MAAM,iCAAiC;oBAEhD,EAAE,EAAE,KAAK,CAAC,CAAC,CAAC;oBAEZ,OAAO,EAAE,GAAG,WAAW,CAAC,UAAU,EAAE;oBAEpC,IAAI,EAAE,GAAG,QAAQ,EAAE;iBACpB,CAAC;gBAEF,4BAAe,CAAC;oBAEd,IAAI,EAAE,mBAAmB;oBACzB,IAAI,EAAE,GAAG;oBACT,gBAAgB,EAAE,IAAI;oBACtB,IAAI,EAAE;wBACJ,IAAI,EAAE,+BAA+B;wBACrC,IAAI,EAAE,eAAe;qBACtB;iBACF,CAAC,CAAC,QAAQ,CAAC,WAAW,EAAE,CAAC,KAAK,EAAE,IAAI,EAAE,EAAE;oBACvC,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;wBACV,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;wBACnB,MAAM,CAAC,EAAC,IAAI,EAAE,GAAG,EAAE,OAAO,EAAE,aAAa,EAAC,CAAC;oBAC7C,CAAC;oBACD,OAAO,CAAC,GAAG,CAAC,gBAAgB,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAC;gBAChD,CAAC,CAAC,CAAC;gBACH,MAAM,CAAC,EAAC,IAAI,EAAE,GAAG,EAAE,OAAO,EAAE,MAAM,EAAC,CAAC;YACtC,CAAC;QACH,CAAC;KAAA;IAOK,iBAAiB,CAAC,WAA8B;;YACpD,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;gBAC5C,MAAM,CAAC,EAAC,IAAI,EAAE,GAAG,EAAE,OAAO,EAAE,MAAM,EAAC,CAAC;YACtC,CAAC;YAAC,KAAK,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;gBACf,MAAM,CAAC,EAAC,IAAI,EAAE,GAAG,EAAE,OAAO,EAAE,YAAY,GAAG,KAAK,CAAC,QAAQ,EAAE,EAAC,CAAC;YAC/D,CAAC;QACH,CAAC;KAAA;CACF,CAAA;AAtEY,YAAY;IADxB,mBAAU,EAAE;IAGT,WAAA,0BAAgB,CAAC,sCAAiB,CAAC,CAAA;qCACH,oBAAU;GAHjC,YAAY,CAsExB;AAtEY,oCAAY","file":"email.service.js","sourcesContent":["import { HttpException, Injectable } from \"@nestjs/common\";\nimport { EmailModuleEntity } from \"../entity/emailModule.entity\";\nimport { render } from \"ejs\";\nimport { createTransport } from \"nodemailer\";\nimport { InjectRepository } from \"@nestjs/typeorm\";\nimport { Repository } from \"typeorm\";\n\n\n@Injectable()\nexport class EmailService {\n constructor(\n   @InjectRepository(EmailModuleEntity)\n   private readonly emailModuleReq: Repository<EmailModuleEntity>,\n ) {}\n\n  /**\n   * 发送邮箱\n   * @param {EmailModuleEntity} emailModule 邮箱模板\n   * @param {any} mContent 邮箱模板\n   * @param {EmailUserEntity[]} emailUser 收信人\n   * @param {string} sender 发信人\n   * @returns {Promise<{code: number; message: string}>}\n   */\n  async sendEmail(mContent: any, mid: number, email: [string], sender: string): Promise<{code, message }> {\n    const emailModule: EmailModuleEntity | undefined = await this.emailModuleReq.findOne(mid);\n    if (!emailModule) {\n      throw new HttpException(\"发送邮箱模板不存在\", 406);\n    }\n    if (email.length <= 0) {\n      throw new HttpException(\"收件人不存在\", 406);\n    }\n    for (let i = 0; i < email.length; i++) {\n      const str = `${emailModule.module}`;\n      // ejs 模板渲染工具，data为参数，str为模板\n      const template = render(str, mContent);\n      const mailOptions = {\n        // 发送人地址必须与服务器连接配置中的auth中的user属性相同\n        from: `${sender}<ibenchu-demo@yzlei.ibenchu.pw>`,\n        // 收件人地址\n        to: email[i],\n        // 邮件主题\n        subject: `${emailModule.emailTheme}`,\n        // 邮件内容\n        html: `${template}`,\n      };\n      // 服务器连接配置\n      createTransport({\n        // 邮箱服务器，这里是阿里云服务器\n        host: \"smtpdm.aliyun.com\",\n        port: 465,\n        secureConnection: true,\n        auth: {\n          user: \"ibenchu-demo@yzlei.ibenchu.pw\",\n          pass: \"ibenchu123QWE\",\n        },\n      }).sendMail(mailOptions, (error, info) => {\n        if (error) {\n          console.log(error);\n          return {code: 200, message: \"发送失败，请稍后重试！\"};\n        }\n        console.log(\"Message sent: \" + info.response);\n      });\n      return {code: 200, message: \"发送成功\"};\n    }\n  }\n\n  /**\n   * 添加短信模板\n   * @param {EmailModuleEntity} emailModule\n   * @returns {Promise<{code; message}>}\n   */\n  async createEmailModule(emailModule: EmailModuleEntity): Promise<{code, message }> {\n    try {\n      await this.emailModuleReq.save(emailModule);\n      return {code: 200, message: \"添加成功\"};\n    } catch (error) {\n      return {code: 406, message: \"添加失败，错误原因：\" + error.toString()};\n    }\n  }\n}\n"]}